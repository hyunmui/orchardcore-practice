name: CI

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master, 'claude/**']

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_PATH: OrchardCore.Practice.sln

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Build (no restore)
        run: dotnet build ${{ env.SOLUTION_PATH }} --no-restore -c Release

      - name: Run tests (no build)
        run: dotnet test ${{ env.SOLUTION_PATH }} --no-build -c Release --logger "trx;LogFileName=test-results.trx" --results-directory ./test-results
        env:
          AI__Claude__ApiKey: test-key-not-used-in-unit-tests

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: .NET Test Results
          path: test-results/**/*.trx
          reporter: dotnet-trx
          fail-on-error: false

  docker-build-validation:
    name: Docker Build Validation
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate Docker image builds
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          push: false
          tags: orchardcore-exhibition:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
